<!DOCTYPE html>
<html>
    <!--
        Demo to illustrate the myClientApp.contacts.showExternalContactProfile(...) SDK method

        Note:  Although this example is hosted with the others here on github; it won't work without
          configuring an OAuth Client and hosting it elsewhere. See js code below for details.

        Reminder: This example is using CDNs and simple javascript to illustrate the SDK. Both the
          PureCloud SDK and Apps SDK can be obtained via npm and support many build tools
          and javascript libraries to fit within your development environment.
    -->
    <head>
        <meta charset="utf-8">
        <title>PureCloud client-app-sdk External Contacts Demo</title>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" integrity="sha384-aUGj/X2zp5rLCbBxumKTCw2Z50WgIr1vs/PFN4praOTvYXWlVyh2UtNUU0KAUhAX" crossorigin="anonymous">

        <script src="https://sdk-cdn.mypurecloud.com/javascript/52.1.1/purecloud-platform-client-v2.min.js"></script>
        <script src="https://sdk-cdn.mypurecloud.com/client-apps/1.3.0/purecloud-client-app-sdk-43593954923a1eb6031c0828e0d4d5d1.min.js"></script>

        <style>

            body {
                padding: 10px;
            }

            #tableBody a{
                cursor: pointer;
            }

            .progress {
                position: relative;
                height: auto;
                text-align: center;
            }

            .progress-bar {
                position: absolute;
                width: 0%;
            }

            .progress-label {
                position: relative;
                color: #000000;
            }

        </style>
    </head>

    <body>
        <noscript>
            For full functionality of this site it is necessary to enable JavaScript. Here are the
            <a href="http://www.enable-javascript.com/" target="_blank">instructions how to enable JavaScript in your web browser</a>.
        </noscript>

        <section class="authenticating">
            <div class="progress">
                <div class="progress-bar"></div>
                <span class="progress-label">Authenticating to PureCloud</span>
            </div>
        </section>

        <table class="contacts table">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Name:</th>
                    <th scope="col">Organization:</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>

        <section class="manual-example">
            <h2>Manual Testers</h2>
            <div class="form-group contact-id">
                <label for="contact-id">Contact Id:</label>
                <input type="text" class="form-control" id="contact-id">
            </div>
            <div class="form-group">
                <button type="button" id="contactButton" class="btn btn-primary">Submit</button>
            </div>
            <div class="form-group org-id">
                <label for="org-id">Organization Id:</label>
                <input type="text" class="form-control" id="org-id">
            </div>
            <div class="form-group">
                <button type="button" id="orgButton" class="btn btn-primary">Submit</button>
            </div>
            <div class="form-group">
                <div class="tester-note">[Note:] These testers intentionally bypass client-side permission checks.</div>
            </div>
        </section>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                let platformClient = window.require('platformClient');
                updateProgressBar(20);

                /*
                * The Client Apps SDK can interpolate the current PC Environment into your app's URL
                * EX: https://mypurecloud.github.io/client-app-sdk/profile.html?pcEnvironment={{pcEnvironment}}
                *
                * Reading the PC Environment from the query string or state param returned from OAuth2 response
                */
                let pcEnvironment = getEmbeddingPCEnv();
                if (!pcEnvironment) {
                    setErrorState(
                        "Cannot identify App Embeddding context.  Did you forget to add pcEnvironment={{pcEnvironment}} to your app's query string?"
                    );
                    return;
                }
                updateProgressBar(40);

                /*
                * Note: To use this app in your own org, you will need to create your own OAuth2 Client(s)
                * in your PureCloud org.  After creating the Implicit grant client, map the client id(s) to
                * the specified region key(s) in the object below, deploy the page, and configure an app to point to that URL.
                */
                let pcOAuthClientIds = { 'mypurecloud.com': 'implicit-oauth-client-id-here' };
                let clientId = pcOAuthClientIds[pcEnvironment];
                if (!clientId) {
                    setErrorState(
                        pcEnvironment + ': Unknown/Unsupported PureCloud Environment'
                    );
                    return;
                }
                updateProgressBar(60);

                let client = platformClient.ApiClient.instance;
                client.setEnvironment(pcEnvironment);

                let clientApp = null;
                try {
                    clientApp = new window.purecloud.apps.ClientApp({
                        pcEnvironment: pcEnvironment
                    });
                } catch (e) {
                    setErrorState(
                        pcEnvironment + ': Unknown/Unsupported PureCloud Embed Context'
                    );
                    return;
                }
                updateProgressBar(80);

                /*
                *  Set up manual tester now; no PC Auth required
                *
                *  This UI is used for testing purposes to manually navigate to a contact by ID.
                *  It purposefully ignores the fact that a user may not be authorized to view external contacts.
                */
                document
                    .querySelector('.manual-example #contactButton')
                    .addEventListener('click', function () {
                        let contactId = document.querySelector('#contact-id').value.trim();
                        if (contactId) {
                            clientApp.contacts.showExternalContactProfile(contactId);
                        }
                    });
                document
                    .querySelector('.manual-example #orgButton')
                    .addEventListener('click', function () {
                        let orgId = document.querySelector('#org-id').value.trim();
                        if (orgId) {
                            clientApp.contacts.showExternalOrganizationProfile(orgId);
                        }
                    });

                let redirectUrl = window.location.origin;
                if (!redirectUrl) {
                    redirectUrl = window.location.protocol + '//' + window.location.host;
                }
                redirectUrl += window.location.pathname;

                // Authenticate with PureCloud
                let authenticated = false;
                let userDataAcquired = false;

                client
                    .loginImplicitGrant(clientId, redirectUrl, {
                        state: 'pcEnvironment=' + pcEnvironment
                    })
                    .then(function () {
                        updateProgressBar(100);
                        authenticated = true;
                        return new platformClient.UsersApi().getUsersMe({
                            expand: ['authorization']
                        });
                    })
                    .then(function (profileData) {
                        userDataAcquired = true;
                        // Check if the current user will be able to view external contacts
                        let permissions = profileData.authorization.permissions;
                        if (checkPermission(permissions, 'externalContacts:contact:view')) {
                            requestExternalContacts().then(data => {
                                let entities = data.entities;
                                // Build table with data from api call
                                for (let i = 0; i < entities.length; i++) {
                                    document.getElementById('tableBody').insertAdjacentHTML('beforeend',
                                        `<tr>
                                            <td>
                                                <a id="entity-${i}">${entities[i].lastName}, ${entities[i].firstName}</a>
                                            </td>
                                            <td>
                                                <a id="org-${i}">${entities[i].externalOrganization.id}</a>
                                            </td>
                                        </tr>`
                                    );
                                    // Attach listeners to entities to call sdk methods
                                    document.getElementById(`entity-${i}`).addEventListener('click', function() {
                                        clientApp.contacts.showExternalContactProfile(entities[i].id);
                                    });
                                    document.getElementById(`org-${i}`).addEventListener('click', function() {
                                        clientApp.contacts.showExternalOrganizationProfile(entities[i].externalOrganization.id);
                                    });

                                }
                            });
                            // Hide progress bar after auth is done
                            let authenticatingEl = document.querySelector('.authenticating');
                            authenticatingEl.classList.add('hidden');
                        } else {
                            setErrorState('You do not have the proper permissions to view external contacts.');
                        }
                    })
                    .catch(function (err) {
                        if (!authenticated) {
                            setErrorState('Failed to Authenticate with PureCloud');
                        } else if (!userDataAcquired) {
                            setErrorState('Failed to locate user in PureCloud');
                        }
                    })

                function setErrorState(errorMsg) {
                    // Display error text in progress bar
                    document.querySelector('.progress-label').innerHTML = errorMsg;
                    document.querySelector('.progress-bar').className += ' progress-bar-danger';
                    updateProgressBar(100);
                }

                /**
                 * Parse the permissions array and check whether or not the match the specified required ones.
                 *
                 * @returns A boolean indicating if the user possesses the required permissions.
                 */
                function checkPermission(permissions, permissionValue) {
                    let isAllowed = false;

                    if (!permissions) {
                        permissions = [];
                    }

                    if (permissionValue.match(/^[a-zA-Z0-9]+:\*$/)) {
                        permissionValue = permissionValue.replace('*', '*:*');
                    }

                    const permissionsToValidate = permissionValue.split(':'),
                        targetDomain = permissionsToValidate[0],
                        targetEntity = permissionsToValidate[1],
                        targetAction = permissionsToValidate[2];

                    permissions.forEach(function (permission) {
                        const permissions = permission.split(':'),
                            domain = permissions[0],
                            entity = permissions[1],
                            actionSet = permissions[2];

                        if (targetDomain === domain) {
                            const matchesEntity = isPermission(targetEntity, entity),
                                matchesAction = isPermission(targetAction, actionSet);

                            if (matchesEntity && matchesAction) {
                                isAllowed = true;
                            }
                        }
                    });

                    return isAllowed;
                }

                function isPermission(item, targetItem) {
                    let isItem = item === '*' || targetItem === '*';
                    if (!isItem) {
                        isItem = item === targetItem;
                    }
                    return isItem;
                }

                /**
                 * Determine the embedding PureCloud environment seeded on the query string or
                 * being returned through the OAuth2 Implicit grant state hash param.
                 *
                 * @returns A string indicating the embedding PC env (e.g. mypurecloud.com, mypurecloud.jp); otherwise, null.
                 */
                function getEmbeddingPCEnv() {
                    let result = null;

                    if (window.location.hash && window.location.hash.indexOf('access_token') >= 0) {
                        let oauthParams = extractParams(window.location.hash.substring(1));
                        if (oauthParams && oauthParams.access_token && oauthParams.state) {
                            // OAuth2 spec dictates this encoding
                            // See: https://tools.ietf.org/html/rfc6749#appendix-B
                            let stateSearch = unescape(oauthParams.state);
                            result = extractParams(stateSearch).pcEnvironment;
                        }
                    }

                    if (!result && window.location.search) {
                        result = extractParams(window.location.search.substring(1)).pcEnvironment || null;
                    }

                    return result;
                }

                // Request first three external contacts from the api
                function requestExternalContacts() {
                    let apiInstance = new platformClient.ExternalContactsApi();
                    let opts = {
                        pageSize: 3,
                        pageNumber: 1
                    }
                    return apiInstance.getExternalcontactsContacts(opts)
                        .then(data => {
                            return data;
                        }).catch(err => {
                            setErrorState(err);
                        });
                }

                function updateProgressBar(percent) {
                    document.querySelector('.progress-bar').style.width = `${percent}%`;
                }
            });
        </script>
    </body>
</html>